<!DOCTYPE html>
<html>
  <head>
    <style>
      /*TODO move this to separate css file */
       #map {
        height: 97vh;
        width: 98vw;
       }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  </head>
  <body>
    <div id="map"></div>
    <script>
      //TODO move this to separate js file

       var m_rad = {{ marker_size }}
       var marker_icon_path = 'M 0, 0 m -'+m_rad+', 0 a '+m_rad+','+m_rad+' 0 1,0 '+2*m_rad+',0 a '+m_rad+','+m_rad+' 0 1,0 -'+2*m_rad+',0';
       var last_success_call_time = 0;

       setInterval(
       function getPoint(){
		$.ajax({
                type: "GET",
                url: "http://localhost:8000/map/getPoints?LastSuccessCallTime=" + last_success_call_time,
                dataType: "json",
                success: parseSuccess,
                error: errorHandler
        });
	  }, 1000);

      function errorHandler(response, options, error){
          console.error("Error while trying to retrieve beacon and drone data from server.");
          console.error(response);
          console.error(response.responseText);
          console.log(error);
      }

      function parseSuccess(response){
        last_success_call_time = response.last_success_call_time;
        addBeaconPoints(response.beacons_positions);
        addDronePoints(response.drones_positions);
      }

      function addDronePoints(points){
        for (var i=0; i<points.length; i++){
          var latitude = parseFloat(points[i].fields.latitude);
          var longitude = parseFloat(points[i].fields.longitude);
          addPoint(latitude, longitude);
        }
      }

      function addBeaconPoints(beacons){
        for (var i=0; i<beacons.length; i++){
          var latitude = parseFloat(beacons[i]['latitude']);
          var longitude = parseFloat(beacons[i]['longitude']);
          addPoint(latitude, longitude);
        }
      }

	  function addPoint(latitude, longitude){
          new google.maps.Marker({
              position: {lat: latitude, lng: longitude },
              map: map,
              icon: {
                  path: marker_icon_path,
                  fillColor: 'red', fillOpacity: 1.0, strokeOpacity: 0.0, scale: 1
              },
              title: latitude + ", " + longitude
          });
      }

      function initMap() {
          var center_pos = {lat: {{ center_lat }}, lng: {{ center_lng }} }
          map = new google.maps.Map(document.getElementById('map'), {
              zoom: {{ zoom }},
              center: center_pos,
              scrollwheel: true,
              draggable: true,
              mapTypeId: 'satellite',
          });

          var areaCoords = [
            {% for lat, lng in areacords %}
            {lat: {{ lat }} , lng: {{ lng }} },
            {% endfor %}
           ];

          var area = new google.maps.Polygon({
            paths: areaCoords,
            strokeColor: 'yellow',
            strokeOpacity: 1,
            strokeWeight: 5,
            fillColor: 'green',
            fillOpacity: 0.3
          });

          area.setMap(map);
      }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBpqpo1bn0gtT0TyjhlgKB_IrfX3NEjN8Y&callback=initMap"></script>
  </body>
</html>